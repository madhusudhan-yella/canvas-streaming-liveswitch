(this["webpackJsonpstreaming-canvas"]=this["webpackJsonpstreaming-canvas"]||[]).push([[0],{18:function(t,e,n){var i={"./fm.liveswitch":0,"./fm.liveswitch.d.ts":19,"./fm.liveswitch.js":0,"./package":10,"./package.json":10};function a(t){var e=s(t);return n(e)}function s(t){if(!n.o(i,t)){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}return i[t]}a.keys=function(){return Object.keys(i)},a.resolve=s,t.exports=a,a.id=18},21:function(t,e,n){},22:function(t,e,n){"use strict";n.r(e);var i=n(2),a=n.n(i),s=n(11),o=n.n(s),c=n(3),r=n(12),h=n(8),u=n(4),d=n(0),l=n.n(d),p="my-app-id",g=function t(e,n,i,a,s){var o=this;Object(u.a)(this,t),this.channel=null,this.localMedia=null,this.canvasUpConnection=null,this.canvasDownConnections={},this.downConnectionTimers={},this.handleClientStateChange=function(t){t.getState()===l.a.ClientState.New&&o.setClientStatus("NEW"),t.getState()===l.a.ClientState.Registering&&o.setClientStatus("REGISTERING"),t.getState()===l.a.ClientState.Registered&&o.setClientStatus("REGISTERED"),t.getState()===l.a.ClientState.Unregistering&&o.setClientStatus("UNREGISTERING"),t.getState()===l.a.ClientState.Unregistered&&o.setClientStatus("UNREGISTERED")},this.register=function(){return new Promise((function(t,e){var n=l.a.Token.generateClientRegisterToken(p,o.client.getUserId(),o.client.getDeviceId(),o.client.getId(),o.client.getRoles(),[new l.a.ChannelClaim(o.callId)],"--replaceThisWithYourOwnSharedSecret--");o.client.register(n).then((function(e){o.channel=e[0],o.channel.addOnRemoteUpstreamConnectionOpen(o.handleUpStream),t()})).fail((function(t){console.error(t),e()}))}))},this.startLocalMedia=function(){return new Promise((function(t,e){var n=document.getElementById("canvas").captureStream(24);o.localMedia=new l.a.LocalMedia(!1,n),o.localMedia.start().then((function(){t()})).fail((function(t){console.error(t),e()}))}))},this.handleUpConnectionStateChange=function(t){t.getState()===l.a.ConnectionState.New&&o.setCanvasUpConnectionStatus("NEW"),t.getState()===l.a.ConnectionState.Initializing&&o.setCanvasUpConnectionStatus("INITIALIZING"),t.getState()===l.a.ConnectionState.Connecting&&o.setCanvasUpConnectionStatus("CONNECTING"),t.getState()===l.a.ConnectionState.Connected&&o.setCanvasUpConnectionStatus("CONNECTED"),t.getState()===l.a.ConnectionState.Closing&&o.setCanvasUpConnectionStatus("CLOSING"),t.getState()===l.a.ConnectionState.Closed&&o.setCanvasUpConnectionStatus("CLOSED"),t.getState()===l.a.ConnectionState.Failing&&o.setCanvasUpConnectionStatus("FAILING"),t.getState()===l.a.ConnectionState.Failed&&o.setCanvasUpConnectionStatus("FAILED")},this.openConnection=function(){var t,e,n=new l.a.VideoStream(o.localMedia);o.canvasUpConnection=null===(t=o.channel)||void 0===t?void 0:t.createSfuUpstreamConnection(n),o.canvasUpConnection.addOnStateChange(o.handleUpConnectionStateChange),null===(e=o.canvasUpConnection)||void 0===e||e.open(),window.setInterval((function(){var t;null===(t=o.canvasUpConnection)||void 0===t||t.getStats().then((function(t){console.log(t.getMediaStream().getTransport().getBytesSent()," --- ",t.getMediaStream().getTransport().getBytesReceived())}))}),5e3)},this.getUpdatedViews=function(t,e,n,i,a){return t.some((function(t){return t.id===e}))?t.map((function(t){return t.id===e?Object(h.a)(Object(h.a)({},t),{},{status:n,view:t.view||i}):Object(h.a)({},t)})):[].concat(Object(r.a)(t),[{id:e,status:n,view:i,userId:a}])},this.handleDownConnectionStateChange=function(t,e,n){t.getState()===l.a.ConnectionState.New&&o.setRemoteViews((function(i){return o.getUpdatedViews(i,t.getId(),"NEW",e.getView(),n.getUserId())})),t.getState()===l.a.ConnectionState.Initializing&&o.setRemoteViews((function(i){return o.getUpdatedViews(i,t.getId(),"INITIALIZE",e.getView(),n.getUserId())})),t.getState()===l.a.ConnectionState.Connecting&&o.setRemoteViews((function(i){return o.getUpdatedViews(i,t.getId(),"CONNECTING",e.getView(),n.getUserId())})),t.getState()===l.a.ConnectionState.Connected&&(o.setRemoteViews((function(i){return o.getUpdatedViews(i,t.getId(),"CONNECTED",e.getView(),n.getUserId())})),o.downConnectionTimers[t.getId()]=window.setInterval((function(){t.getStats().then((function(t){console.log("DOWN ",t.getMediaStream().getTransport().getBytesSent()," --- ",t.getMediaStream().getTransport().getBytesReceived())}))}),5e3)),t.getState()===l.a.ConnectionState.Closing&&o.setRemoteViews((function(i){return o.getUpdatedViews(i,t.getId(),"CLOSING",e.getView(),n.getUserId())})),t.getState()===l.a.ConnectionState.Closed&&(o.setRemoteViews((function(e){return e.filter((function(e){return e.id!==t.getId()}))})),delete o.downConnectionTimers[t.getId()]),t.getState()===l.a.ConnectionState.Failing&&o.setRemoteViews((function(i){return o.getUpdatedViews(i,t.getId(),"FAILING",e.getView(),n.getUserId())})),t.getState()===l.a.ConnectionState.Failed&&(o.setRemoteViews((function(e){return e.filter((function(e){return e.id!==t.getId()}))})),delete o.downConnectionTimers[t.getId()],o.handleUpStream(n))},this.handleUpStream=function(t){var e=new l.a.RemoteMedia,n=new l.a.VideoStream(e),i=o.channel.createSfuDownstreamConnection(t,n);i.addOnStateChange((function(n){return o.handleDownConnectionStateChange(n,e,t)})),o.canvasDownConnections[i.getId()]=i,i.open()},this.callId=e,this.setClientStatus=i,this.setCanvasUpConnectionStatus=a,this.setRemoteViews=s,this.client=new l.a.Client("https://demo.liveswitch.fm:8443/sync",p,n),this.client.addOnStateChange(this.handleClientStateChange)},f=n(7),v=n(1),w=function(){return Object(i.useEffect)((function(){!function(){window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)};var t=.5,e=document.getElementById("canvas"),n=e.getContext("2d");e.width=e.parentElement.offsetWidth,e.height=e.parentElement.offsetHeight,n.strokeStyle="#555";var i={cut:8,influence:26,down:!1,button:1,x:0,y:0,px:0,py:0},a=function(){function n(t,e){Object(u.a)(this,n),this.x=t,this.y=e,this.px=t,this.py=e,this.vx=0,this.vy=0,this.pinX=null,this.pinY=null,this.constraints=[]}return Object(f.a)(n,[{key:"update",value:function(n){if(this.pinX&&this.pinY)return this;if(i.down){var a=this.x-i.x,s=this.y-i.y,o=Math.sqrt(a*a+s*s);1===i.button&&o<i.influence?(this.px=this.x-(i.x-i.px),this.py=this.y-(i.y-i.py)):o<i.cut&&(this.constraints=[])}this.addForce(0,400);var c=this.x+.99*(this.x-this.px)+this.vx*n,r=this.y+.99*(this.y-this.py)+this.vy*n;return this.px=this.x,this.py=this.y,this.x=c,this.y=r,this.vy=this.vx=0,this.x>=e.width?(this.px=e.width+(e.width-this.px)*t,this.x=e.width):this.x<=0&&(this.px*=-.5,this.x=0),this.y>=e.height?(this.py=e.height+(e.height-this.py)*t,this.y=e.height):this.y<=0&&(this.py*=-.5,this.y=0),this}},{key:"draw",value:function(){for(var t=this.constraints.length;t--;)this.constraints[t].draw()}},{key:"resolve",value:function(){if(this.pinX&&this.pinY)return this.x=this.pinX,void(this.y=this.pinY);this.constraints.forEach((function(t){return t.resolve()}))}},{key:"attach",value:function(t){this.constraints.push(new s(this,t))}},{key:"free",value:function(t){this.constraints.splice(this.constraints.indexOf(t),1)}},{key:"addForce",value:function(t,e){this.vx+=t,this.vy+=e}},{key:"pin",value:function(t,e){this.pinX=t,this.pinY=e}}]),n}(),s=function(){function t(e,n){Object(u.a)(this,t),this.p1=e,this.p2=n,this.length=8}return Object(f.a)(t,[{key:"resolve",value:function(){var t=this.p1.x-this.p2.x,e=this.p1.y-this.p2.y,n=Math.sqrt(t*t+e*e);if(!(n<this.length)){var i=(this.length-n)/n;n>60&&this.p1.free(this);var a=.5*i*(1-this.length/n),s=t*a,o=e*a;return!this.p1.pinX&&(this.p1.x+=s),!this.p1.pinY&&(this.p1.y+=o),!this.p2.pinX&&(this.p2.x-=s),!this.p2.pinY&&(this.p2.y-=o),this}}},{key:"draw",value:function(){n.moveTo(this.p1.x,this.p1.y),n.lineTo(this.p2.x,this.p2.y)}}]),t}(),o=function(){function t(){Object(u.a)(this,t),this.points=[];for(var n=e.width/2-216,i=0;i<=28;i++)for(var s=0;s<=54;s++){var o=new a(n+8*s,20+8*i);0===i&&o.pin(o.x,o.y),0!==s&&o.attach(this.points[this.points.length-1]),0!==i&&o.attach(this.points[s+55*(i-1)]),this.points.push(o)}}return Object(f.a)(t,[{key:"update",value:function(t){for(var e=5;e--;)this.points.forEach((function(t){t.resolve()}));n.beginPath(),this.points.forEach((function(e){e.update(t*t).draw()})),n.stroke()}}]),t}();function c(t){var n=e.getBoundingClientRect();i.px=i.x,i.py=i.y,i.x=t.clientX-n.left,i.y=t.clientY-n.top}e.onmousedown=function(t){i.button=t.which,i.down=!0,c(t)},e.onmousemove=c,e.onmouseup=function(){return i.down=!1},e.oncontextmenu=function(t){return t.preventDefault()};var r=new o;!function t(i){n.clearRect(0,0,e.width,e.height),r.update(.016),window.requestAnimFrame(t)}()}()}),[]),Object(v.jsx)("canvas",{id:"canvas"})},C=function(t){var e=Object(i.useRef)();return Object(i.useEffect)((function(){t.view&&e.current&&(t.view.style.width="100%",t.view.style.height="100%",t.view.style.position="relative",t.view.style["object-fit"]="contain",e.current.innerHTML="",e.current.appendChild(t.view))}),[t.view]),Object(v.jsx)("div",{style:{width:"100%",height:"100%"},ref:e})},S=function(){var t=Object(i.useState)(null),e=Object(c.a)(t,2),n=e[0],a=e[1],s=Object(i.useState)(null),o=Object(c.a)(s,2),r=o[0],h=o[1],u=Object(i.useState)([]),d=Object(c.a)(u,2),l=d[0],p=d[1],f=Object(i.useState)(!1),S=Object(c.a)(f,2),m=S[0],y=S[1],j=Object(i.useState)(!1),O=Object(c.a)(j,2),x=O[0],b=O[1],I=Object(i.useState)(""),U=Object(c.a)(I,2),E=U[0],N=U[1];Object(i.useEffect)((function(){var t=window.location.pathname.split("/");t.shift();var e=t.filter((function(t){return!!t}));if(2===e.length){var n=Object(c.a)(e,2),i=n[0],s=n[1],o=new g(i,s,a,h,p);b(!0),o.register().then((function(){o.startLocalMedia().then((function(){y(o),b(!1)})).catch((function(){N("start local media failed, reload to retry")}))})).catch((function(){N("registration failed, reload to retry")}))}else N("Your url is not correct, it should be https://test.com/callid/userid. Please reload the page with correct route params")}),[]);return Object(v.jsxs)("div",{children:[Object(v.jsxs)("div",{children:["Client Status: ",n]}),Object(v.jsxs)("div",{children:["Up Connection Status: ",r]}),Object(v.jsx)("button",{disabled:x||E,onClick:function(){N("you can only send stream once"),m.openConnection()},children:"SEND Stream"}),E&&Object(v.jsx)("span",{style:{color:"red"},children:E}),Object(v.jsxs)("div",{className:"app-container",children:[Object(v.jsx)("div",{className:"canvas-container",children:Object(v.jsx)(w,{})}),Object(v.jsx)("div",{className:"remote-views",children:l.map((function(t){return console.log(t),Object(v.jsxs)("div",{className:"remote-view-item",children:[Object(v.jsx)("div",{children:t.userId}),Object(v.jsx)("div",{children:t.status}),t.view&&Object(v.jsx)(C,{view:t.view})]},t.id)}))})]})]})},m=(n(21),Object(v.jsx)(a.a.StrictMode,{children:Object(v.jsx)(S,{})}));o.a.render(m,document.getElementById("root"))}},[[22,1,2]]]);
//# sourceMappingURL=main.e5244a58.chunk.js.map